name: CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  Dependances:
    name: V√©rification et installation des d√©pendances
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: V√©rifier que requirements.txt existe
        run: |
          if [ ! -f "requirements.txt" ]; then
            echo "requirements.txt manquant !"
            exit 1
          fi
          echo "‚úì requirements.txt trouv√©"

      - name: V√©rifier que requirements.txt n'est pas vide
        run: |
          if [ ! -s "requirements.txt" ]; then
            echo "requirements.txt est vide !"
            exit 1
          fi
          echo "‚úì requirements.txt non vide"

      - name: Tester l'installation des d√©pendances
        run: |
          pip install -r requirements.txt
          echo "‚úì D√©pendances installables"

  Dockerfile:
    name: V√©rification et construction Docker
    runs-on: ubuntu-latest
    needs: Dependances
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: V√©rifier que Dockerfile existe
        run: |
          if [ ! -f "Dockerfile" ]; then
            echo "Dockerfile manquant !"
            exit 1
          fi
          echo "‚úì Dockerfile trouv√©"

      - name: Tester la construction Docker
        run: |
          docker build -t imgvulne:1.1 .
          echo "‚úì Dockerfile OK ‚Äî image Docker construite"

  Vulnerabilities:
    name: Scan des vuln√©rabilit√©s
    runs-on: ubuntu-latest
    needs: Dockerfile
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Installer jq et column pour formatage
        run: sudo apt-get update && sudo apt-get install -y jq bsdmainutils

      - name: Scanner vuln√©rabilit√©s des d√©pendances Python
        run: |
          echo "üîç Scan des vuln√©rabilit√©s dans requirements.txt"
          docker run --rm \
            -v "$PWD":/project \
            -v $HOME/.cache/trivy:/root/.cache/ \
            aquasec/trivy:latest fs /project/requirements.txt || echo "Scan termin√© avec vuln√©rabilit√©s"

      - name: Scanner vuln√©rabilit√©s de l'image Docker
        run: |
          echo "üîç Scan des vuln√©rabilit√©s dans l'image Docker imgvulne:1.1"
          docker run --rm \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -v "$HOME/.cache/trivy":/root/.cache/ \
            aquasec/trivy:latest image --format json --severity HIGH,CRITICAL imgvulne:1.1 \
          | jq -r '
            ["TARGET","PACKAGE","INSTALLED","VULN","SEVERITY"],
            (.Results[]? as $r | $r.Vulnerabilities[]? | [$r.Target, .PkgName, .InstalledVersion, .VulnerabilityID, .Severity]) 
            | @tsv' \
          | column -t -s $'\t' || echo "Scan termin√© avec vuln√©rabilit√©s"
